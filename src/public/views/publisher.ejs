<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicador Millicast</title>
    <script src="https://cdn.jsdelivr.net/npm/@millicast/sdk/dist/millicast.umd.min.js"></script>
</head>
<body>
    <h1>Publicador Millicast</h1>
    <label for="streamName">Nome do Stream</label>
    <input id="streamName" type="text" value="test" />
    <button onclick="startPublishing()">Iniciar Publicação</button>

    <script>
        const servicePath = "/createToken";

        async function startPublishing() {
            const streamName = document.getElementById("streamName").value;

            if (!streamName) {
                alert("Por favor, insira um nome para o stream");
                return;
            }

            const response = await fetch(servicePath, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ streamName })
            });

            const data = await response.json();

            const token = data.token;
            const streamId = data.streamId;

            const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });

            const tokenGenerator = () => Promise.resolve({ token });

            const publisher = new window.millicast.Publish(streamName, tokenGenerator);

            const broadcastOptions = {
                mediaStream: mediaStream
            };

            try {
                await publisher.connect(broadcastOptions);
                alert('Transmissão iniciada!');
            } catch (error) {
                console.error('Falha na conexão', error);
            }
        }
    </script>
</body>
</html>